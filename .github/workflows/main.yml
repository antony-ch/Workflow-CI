# Workflow-CI/.github/workflows/main.yml
name: CI/CD MLflow Model Retraining

on:
  push:
    branches:
      - main # Trigger saat ada push ke branch main
  workflow_dispatch: # Memungkinkan trigger manual dari GitHub UI

jobs:
  retrain_model:
    runs-on: ubuntu-latest # Menggunakan runner Ubuntu terbaru

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.12.7 # Pastikan ini sama dengan di conda.yaml
          activate-environment: mlflow-project-env # Nama env dari conda.yaml
          auto-activate-base: false # Hindari aktivasi base env

      - name: Install dependencies
        shell: bash
        run: |
          conda activate mlflow-project-env
          pip install -r MLProject/requirements.txt # Jika ada requirements.txt terpisah, gunakan ini
          # Atau jika semua sudah di conda.yaml:
          # conda env update --file MLProject/conda.yaml

      - name: Configure DagsHub credentials
        shell: bash
        run: |
          # Menggunakan secrets untuk username dan token DagsHub
          export MLFLOW_TRACKING_USERNAME="${{ secrets.DAGSHUB_USERNAME }}"
          export MLFLOW_TRACKING_PASSWORD="${{ secrets.DAGSHUB_TOKEN }}"
          export MLFLOW_TRACKING_URI="https://dagshub.com/antony-ch/Eksperimen_SML_AntonyCH.mlflow"
          echo "MLflow tracking URI set to DagsHub."

          # Menginisialisasi DagsHub secara eksplisit (penting untuk MLflow Project)
          python -c "import dagshub; dagshub.init(repo_owner='antony-ch', repo_name='Eksperimen_SML_AntonyCH', mlflow=True)"

      - name: Run MLflow Project
        shell: bash
        run: |
          conda activate mlflow-project-env
          mlflow run MLProject -P alpha=0.5 -P l1_ratio=0.5 # Jika ada parameter
          # Jika modelling.py tidak menerima parameter:
          # mlflow run MLProject
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/antony-ch/Eksperimen_SML_AntonyCH.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

      # --- BAGIAN UNTUK SKILLED (3 pts): Menyimpan Artefak ke Repo GitHub ---
      # Ini akan mengupload artefak (gambar CM dan ROC) kembali ke repo GitHub ini
      - name: Upload MLflow artifacts to GitHub repo
        uses: actions/upload-artifact@v4 # Gunakan versi terbaru
        with:
          name: mlflow-run-artifacts
          path: |
            mlruns/ # MLflow artifacts disimpan di folder mlruns
            # Tambahkan path spesifik jika Anda tahu di mana MLflow menyimpan artefak
            # Misalnya: MLProject/confusion_matrix.png (jika Anda simpan di situ secara manual)
          retention-days: 7 # Opsional: Berapa lama artefak disimpan di GitHub

      # --- OPSIONAL UNTUK ADVANCE (4 pts): Build Docker Image (PERHATIAN KINERJA) ---
      # Ini hanya sebagai contoh, JANGAN JALANKAN jika device kentang
      # - name: Build and Push Docker Image
      #   if: always() # Jalankan ini bahkan jika langkah sebelumnya gagal
      #   shell: bash
      #   run: |
      #     mlflow build-docker MLProject --model-path "model" --image-name my-mlflow-model-image:latest --no-push
      #     # Jika ingin push ke Docker Hub:
      #     # echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin
      #     # mlflow build-docker MLProject --model-path "model" --image-name my-mlflow-model-image:latest --push
      # env:
      #   MLFLOW_TRACKING_URI: https://dagshub.com/antony-ch/Eksperimen_SML_AntonyCH.mlflow
      #   MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      #   MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}